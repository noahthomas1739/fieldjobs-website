(()=>{var e={};e.id=4090,e.ids=[4090],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},26065:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>h,routeModule:()=>p,serverHooks:()=>_,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{POST:()=>u});var o=t(96559),i=t(48088),n=t(37719),a=t(32190),c=t(61223),l=t(44999);async function u(e){try{let r=(0,l.UL)(),t=(0,c.createRouteHandlerClient)({cookies:()=>r}),{profileId:s,userId:o}=await e.json();if(!s||!o)return a.NextResponse.json({success:!1,error:"Profile ID and User ID are required"},{status:400});console.log("\uD83D\uDD13 Unlocking profile:",{profileId:s,userId:o});let{data:i,error:n}=await t.from("credit_balances").select("monthly_credits, purchased_credits, last_monthly_refresh").eq("user_id",o).single();if(n||!i){console.error("❌ Error fetching credit balance:",n);let{data:e}=await t.from("subscriptions").select("plan_type").eq("user_id",o).single(),r={growth:5,professional:25,enterprise:100}[e?.plan_type]||0,{data:s,error:c}=await t.from("credit_balances").insert({user_id:o,monthly_credits:r,purchased_credits:0,last_monthly_refresh:new Date().toISOString().split("T")[0]}).select().single();if(c)return a.NextResponse.json({success:!1,error:"Failed to initialize credit balance"},{status:500});i=s}let u=new Date,p=new Date(i.last_monthly_refresh);if(Math.floor((u-p)/864e5)>=30){console.log("\uD83D\uDD04 Refreshing monthly credits for user:",o);let{data:e}=await t.from("subscriptions").select("plan_type").eq("user_id",o).single(),r={growth:5,professional:25,enterprise:100}[e?.plan_type]||0,{error:s}=await t.from("credit_balances").update({monthly_credits:r,last_monthly_refresh:u.toISOString().split("T")[0],updated_at:new Date().toISOString()}).eq("user_id",o);s||(i.monthly_credits=r)}let d=i.monthly_credits+i.purchased_credits;if(d<1)return console.log("❌ Insufficient credits:",d),a.NextResponse.json({success:!1,error:"Insufficient credits"},{status:400});let f=i.monthly_credits,_=i.purchased_credits;f>0?(f-=1,console.log("\uD83D\uDCB3 Using monthly credit. Remaining monthly:",f)):(_-=1,console.log("\uD83D\uDCB0 Using purchased credit. Remaining purchased:",_));let{error:h}=await t.from("credit_balances").update({monthly_credits:f,purchased_credits:_,updated_at:new Date().toISOString()}).eq("user_id",o);if(h)return console.error("❌ Error updating credits:",h),a.NextResponse.json({success:!1,error:"Failed to deduct credit"},{status:500});let{error:g}=await t.from("profile_unlocks").insert({employer_id:o,job_seeker_id:s,unlocked_at:new Date().toISOString()});g&&console.warn("⚠️ Failed to log unlock action:",g);let m=f+_;return console.log(`✅ Profile unlocked! Total credits remaining: ${m}`),a.NextResponse.json({success:!0,creditsRemaining:m,message:"Profile unlocked successfully"})}catch(e){return console.error("❌ Unlock profile server error:",e),a.NextResponse.json({success:!1,error:"Server error while unlocking profile"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/unlock-profile/route",pathname:"/api/unlock-profile",filename:"route",bundlePath:"app/api/unlock-profile/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/unlock-profile/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:d,workUnitAsyncStorage:f,serverHooks:_}=p;function h(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:f})}},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,2307,3605,2190],()=>t(26065));module.exports=s})();