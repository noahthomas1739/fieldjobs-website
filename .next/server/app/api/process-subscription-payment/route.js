(()=>{var e={};e.id=6488,e.ids=[6488],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},12968:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>g,routeModule:()=>d,serverHooks:()=>x,workAsyncStorage:()=>b,workUnitAsyncStorage:()=>_});var r={};s.r(r),s.d(r,{POST:()=>l});var i=s(96559),o=s(48088),n=s(37719),a=s(32190),c=s(61223),p=s(44999);let u=new(s(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");async function l(e){try{let t=(0,p.UL)(),s=(0,c.createRouteHandlerClient)({cookies:()=>t}),{sessionId:r,planType:i,userId:o}=await e.json();if(!r)return a.NextResponse.json({error:"Session ID is required"},{status:400});let n=await u.checkout.sessions.retrieve(r);if("paid"!==n.payment_status)return a.NextResponse.json({error:"Payment not completed"},{status:400});let l=n.metadata?.userId||o,d=n.metadata?.newPlan||i,b=n.metadata?.type==="subscription_upgrade";if(!l||!d)return a.NextResponse.json({error:"Missing user or plan information"},{status:400});console.log(`🔄 Processing ${b?"upgrade":"new subscription"} for user:`,l,"to plan:",d);let _={starter:{active_jobs_limit:3,credits:5,price:19900},growth:{active_jobs_limit:6,credits:10,price:29900},professional:{active_jobs_limit:15,credits:25,price:59900},enterprise:{active_jobs_limit:999,credits:999,price:199900}}[d];if(!_)return a.NextResponse.json({error:"Invalid plan type"},{status:400});console.log("\uD83E\uDDF9 Cleaning up all existing active subscriptions...");let{data:x}=await s.from("subscriptions").select("id, stripe_subscription_id").eq("user_id",l).eq("status","active");if(x&&x.length>0){for(let e of(console.log(`Found ${x.length} existing active subscriptions to cancel`),x))if(e.stripe_subscription_id)try{let t=await u.subscriptions.retrieve(e.stripe_subscription_id);"active"===t.status&&(await u.subscriptions.cancel(e.stripe_subscription_id),console.log("✅ Cancelled Stripe subscription:",e.stripe_subscription_id))}catch(t){console.log("ℹ️ Stripe subscription already cancelled or not found:",e.stripe_subscription_id)}await s.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString()}).eq("user_id",l).eq("status","active"),console.log("✅ Marked all existing subscriptions as cancelled")}let{data:g,error:m}=await s.from("subscriptions").insert([{user_id:l,plan_type:d,status:"active",active_jobs_limit:_.active_jobs_limit,credits:_.credits,price:_.price,stripe_customer_id:n.customer,stripe_subscription_id:n.subscription,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}]).select().single();if(m)return console.error("❌ Error creating new subscription:",m),a.NextResponse.json({error:"Failed to create new subscription",details:m.message},{status:500});console.log("✅ Created new subscription:",g);let{data:v}=await s.from("subscriptions").select("id, plan_type").eq("user_id",l).eq("status","active");return console.log(`✅ Final check: User now has ${v?.length||0} active subscription(s)`),a.NextResponse.json({success:!0,message:`Successfully ${b?"changed to":"subscribed to"} ${d} plan!`,plan:d,subscription:g})}catch(e){return console.error("❌ Error processing subscription payment:",e),a.NextResponse.json({error:"Failed to process subscription payment",details:e.message},{status:500})}}let d=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/process-subscription-payment/route",pathname:"/api/process-subscription-payment",filename:"route",bundlePath:"app/api/process-subscription-payment/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/process-subscription-payment/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:b,workUnitAsyncStorage:_,serverHooks:x}=d;function g(){return(0,n.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:_})}},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[4243,131,2190,7877],()=>s(12968));module.exports=r})();