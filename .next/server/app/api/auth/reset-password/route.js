(()=>{var e={};e.id=6478,e.ids=[6478],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},7185:(e,r,s)=>{"use strict";s.r(r),s.d(r,{patchFetch:()=>h,routeModule:()=>p,serverHooks:()=>x,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>v});var t={};s.r(t),s.d(t,{POST:()=>l});var o=s(96559),a=s(48088),i=s(37719),n=s(61223),u=s(44999),c=s(32190);async function l(e){try{let{password:r,token:s,type:t,code:o}=await e.json();if(console.log("Server: Received request with:",{hasPassword:!!r,hasToken:!!s,type:t,hasCode:!!o,tokenPrefix:s?s.substring(0,10)+"...":"none"}),!r||r.length<6)return c.NextResponse.json({error:"Password must be at least 6 characters"},{status:400});let a=(0,n.createRouteHandlerClient)({cookies:u.UL});if(s&&"recovery"===t){console.log("Server: Attempting OTP verification...");try{let e=s.trim();console.log("Server: Using clean token:",e.substring(0,15)+"...");let{data:r,error:t}=await a.auth.verifyOtp({token_hash:e,type:"recovery"});if(console.log("Server: OTP verification result:",{hasData:!!r,hasSession:!!r?.session,hasUser:!!r?.user,error:t?.message}),t)return console.error("Server: OTP verification failed:",t),r?.user&&console.log("Server: Trying to create session manually..."),c.NextResponse.json({error:`OTP verification failed: ${t.message}`},{status:401});if(!r?.session)return console.log("Server: ⚠️ OTP verified but no session created"),c.NextResponse.json({error:"Token verified but session not established"},{status:401});console.log("Server: ✅ OTP verified, session established for user:",r.user?.email)}catch(e){return console.error("Server: OTP verification exception:",e),c.NextResponse.json({error:`OTP verification exception: ${e.message}`},{status:401})}}else{if(!o)return console.log("Server: No valid reset parameters provided"),c.NextResponse.json({error:"Missing reset parameters"},{status:400});console.log("Server: Attempting code exchange...");try{let{data:e,error:r}=await a.auth.exchangeCodeForSession(o);if(r)return console.error("Server: Code exchange error:",r),c.NextResponse.json({error:"Invalid or expired code"},{status:401});console.log("Server: Code exchange successful")}catch(e){return console.error("Server: Code exchange failed:",e),c.NextResponse.json({error:"Failed to establish session from code"},{status:401})}}let{data:{session:i},error:l}=await a.auth.getSession();if(console.log("Server: Final session check:",{hasSession:!!i,hasUser:!!i?.user,userEmail:i?.user?.email,sessionError:l?.message}),l||!i)return console.error("Server: No valid session found after auth"),c.NextResponse.json({error:"No valid session established"},{status:401});console.log("Server: \uD83D\uDE80 Updating password for user:",i.user.email);let{error:p}=await a.auth.updateUser({password:r});if(p)return console.error("Server: Password update failed:",p),c.NextResponse.json({error:p.message},{status:400});return console.log("Server: ✅ Password updated successfully!"),await a.auth.signOut(),c.NextResponse.json({message:"Password updated successfully"})}catch(e){return console.error("Server: Unexpected error:",e),c.NextResponse.json({error:"Server error occurred"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/auth/reset-password/route",pathname:"/api/auth/reset-password",filename:"route",bundlePath:"app/api/auth/reset-password/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/auth/reset-password/route.js",nextConfigOutput:"",userland:t}),{workAsyncStorage:d,workUnitAsyncStorage:v,serverHooks:x}=p;function h(){return(0,i.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:v})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var s=e=>r(r.s=e),t=r.X(0,[4243,2307,3605,2190],()=>s(7185));module.exports=t})();