(()=>{var e={};e.id=179,e.ids=[179],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},48479:(e,r,o)=>{"use strict";o.r(r),o.d(r,{patchFetch:()=>b,routeModule:()=>f,serverHooks:()=>j,workAsyncStorage:()=>m,workUnitAsyncStorage:()=>_});var t={};o.r(t),o.d(t,{GET:()=>u,POST:()=>d,PUT:()=>g});var s=o(96559),i=o(48088),a=o(37719),n=o(32190),l=o(61223),p=o(44999);let c=async(e,r,o)=>{try{console.log(`ðŸ”” Checking if first application prompt needed for job ${r}`);let{data:t,error:s}=await e.from("jobs").select("is_free_job, title, user_id").eq("id",r).single();if(s||!t)return void console.error("Error fetching job for prompt:",s);if(!t.is_free_job)return void console.log("Job is not a free job, skipping prompt");let{data:i,error:a}=await e.from("applications").select("id").eq("job_id",r);if(a)return void console.error("Error checking existing applications:",a);let n=i?.length||0;if(console.log(`ðŸ“Š Application count for job ${r}: ${n}`),1===n){let{data:t,error:s}=await e.from("upgrade_prompts").select("id").eq("job_id",r).eq("prompt_type","first_application").single();if(s&&"PGRST116"!==s.code)return void console.error("Error checking existing prompt:",s);if(!t){let{error:t}=await e.from("upgrade_prompts").insert({user_id:o,job_id:r,prompt_type:"first_application",triggered_at:new Date().toISOString()});t?console.error("Error creating upgrade prompt:",t):console.log(`âœ… Created first application prompt for job ${r}`)}}}catch(e){console.error("Error in triggerFirstApplicationPrompt:",e)}};async function u(e){try{console.log("\uD83D\uDD0D Applications API called");let{searchParams:r}=new URL(e.url),o=r.get("userId"),t=r.get("employerId");console.log("\uD83D\uDCCB Parameters:",{userId:o,employerId:t});let s=(0,p.UL)(),i=(0,l.createRouteHandlerClient)({cookies:()=>s});if(!o&&!t)return n.NextResponse.json({error:"User ID or Employer ID required"},{status:400});let a=[];if(o){console.log("\uD83D\uDC64 Fetching applications for job seeker:",o);let{data:e,error:r}=await i.from("applications").select(`
          *,
          jobs!inner(id, title, company, user_id, status)
        `).eq("applicant_id",o).order("applied_at",{ascending:!1});if(r)return console.error("âŒ Error fetching user applications:",r),n.NextResponse.json({error:"Failed to fetch user applications",details:r.message},{status:500});a=e||[],console.log("\uD83D\uDCCA Found",a.length,"applications for user")}else if(t){console.log("\uD83C\uDFE2 Fetching applications for employer:",t);let{data:e,error:r}=await i.from("applications").select(`
          *,
          jobs!inner(id, title, company, user_id, status)
        `).eq("jobs.user_id",t).order("applied_at",{ascending:!1});if(r)return console.error("âŒ Error fetching employer applications:",r),n.NextResponse.json({error:"Failed to fetch employer applications",details:r.message},{status:500});a=e||[],console.log("\uD83D\uDCCA Found",a.length,"applications for employer")}return console.log("âœ… Applications fetched successfully"),n.NextResponse.json({success:!0,applications:a,count:a.length})}catch(e){return console.error("\uD83D\uDCA5 Unexpected error in applications API:",e),n.NextResponse.json({error:"Internal server error",details:e.message,stack:void 0},{status:500})}}async function d(e){try{console.log("\uD83D\uDCDD Creating new application");let{jobId:r,userId:o,firstName:t,lastName:s,email:i,phone:a,classification:u}=await e.json(),d=(0,p.UL)(),g=(0,l.createRouteHandlerClient)({cookies:()=>d});if(!r||!o||!t||!s||!i||!a)return n.NextResponse.json({error:"Missing required fields"},{status:400});let{data:f,error:m}=await g.from("applications").select("id").eq("job_id",r).eq("applicant_id",o).single();if(m&&"PGRST116"!==m.code)return console.error("Error checking existing application:",m),n.NextResponse.json({error:"Database error while checking application"},{status:500});if(f)return n.NextResponse.json({error:"You have already applied to this job"},{status:409});let{data:_,error:j}=await g.from("jobs").select("id, title, company, user_id, is_free_job").eq("id",r).single();if(j)return console.error("Error fetching job:",j),n.NextResponse.json({error:"Job not found"},{status:404});let{data:b,error:h}=await g.from("profiles").select("resume_url").eq("id",o).single();h&&console.error("Error fetching user profile:",h);let x={job_id:r,applicant_id:o,first_name:t,last_name:s,email:i,phone:a,classification:u||"",status:"pending",resume_url:b?.resume_url||null,applied_at:new Date().toISOString(),created_at:new Date().toISOString()};console.log("\uD83D\uDCDD Attempting to create application with data:",x);let{data:y,error:R}=await g.from("applications").insert(x).select().single();if(R)return console.error("âŒ Error creating application:",R),console.error("âŒ Application data that failed:",x),console.error("âŒ Error details:",{code:R.code,message:R.message,details:R.details,hint:R.hint}),n.NextResponse.json({error:"Failed to submit application",details:R.message},{status:500});if(!y)return console.error("âŒ Application creation returned no data and no error"),n.NextResponse.json({error:"Application creation failed - no data returned"},{status:500});console.log("âœ… Application created successfully"),console.log("\uD83D\uDCE7 Application ID for email:",y.id),console.log("\uD83D\uDCE7 Application data:",{id:y.id,job_id:y.job_id,applicant_id:y.applicant_id,created_at:y.created_at});try{await new Promise(e=>setTimeout(e,500)),console.log("\uD83D\uDCE7 Calling email API with application ID:",y.id),(await fetch(`${process.env.NEXT_PUBLIC_BASE_URL||"https://field-jobs.co"}/api/send-application-emails`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({applicationId:y.id,jobId:r,applicantId:o,employerId:_.user_id})})).ok?console.log("\uD83D\uDCE7 Application emails sent successfully"):console.error("\uD83D\uDCE7 Failed to send application emails")}catch(e){console.error("\uD83D\uDCE7 Email sending error:",e)}return _.is_free_job&&_.user_id&&await c(g,r,_.user_id),n.NextResponse.json({success:!0,message:"Application submitted successfully",application:{id:y.id,job_title:_.title,company:_.company,applied_at:y.applied_at}})}catch(e){return console.error("Error submitting application:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}async function g(e){try{console.log("\uD83D\uDEA8 PUT METHOD CALLED - Starting application status update"),console.log("\uD83D\uDD04 Updating application status");let{applicationId:r,status:t,userId:s}=await e.json();console.log("\uD83D\uDCE5 Request body:",{applicationId:r,status:t,userId:s});let i=(0,p.UL)(),a=(0,l.createRouteHandlerClient)({cookies:()=>i});if(!r||!t||!s)return console.error("âŒ Missing required fields:",{applicationId:r,status:t,userId:s}),n.NextResponse.json({error:"Missing required fields: applicationId, status, userId"},{status:400});console.log("\uD83D\uDD0D Looking for application:",r,"for user:",s);let{data:c,error:u}=await a.from("applications").select("*").eq("id",r).single();if(console.log("\uD83D\uDD0D Application fetch result:",{application:c,fetchError:u}),u)return console.error("âŒ Error fetching application:",u),n.NextResponse.json({error:"Application not found: "+u.message},{status:404});if(!c)return console.error("âŒ Application not found"),n.NextResponse.json({error:"Application not found"},{status:404});console.log("âœ… Found application:",c.id,"for job:",c.job_id);let{data:d,error:g}=await a.from("jobs").select("user_id").eq("id",c.job_id).single();if(console.log("\uD83D\uDD0D Job fetch result:",{job:d,jobError:g,jobId:c.job_id}),g||!d)return console.error("âŒ Error fetching job:",g),n.NextResponse.json({error:"Job not found for this application"},{status:404});if(console.log("âœ… Found job with employer:",d.user_id,"requesting user:",s),console.log("\uD83D\uDD0D User ID type:",typeof d.user_id,"Requesting User ID type:",typeof s),console.log("\uD83D\uDD0D User ID === Requesting User ID:",d.user_id===s),console.log("\uD83D\uDD0D User ID == Requesting User ID:",d.user_id==s),d.user_id!==s&&d.user_id!==String(s))return console.error("âŒ Unauthorized: User",s,"is not employer",d.user_id),n.NextResponse.json({error:"Unauthorized: You can only update applications for your jobs"},{status:403});console.log("\uD83D\uDD04 Attempting database update for application:",r),console.log("\uD83D\uDCDD Status being set:",t);let{createClient:f}=o(66437),m=f(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY);console.log("\uD83D\uDD0D Current application status:",c.status),console.log("\uD83D\uDD0D Setting status to:",t);let{data:_,error:j}=await m.from("applications").update({status:t}).eq("id",r).select(),b=_?.[0];if(j)return console.error("âŒ Database update error:",j),n.NextResponse.json({error:"Failed to update application status: "+j.message},{status:500});if(!b)return console.error("âŒ No application was updated - possibly wrong ID or permissions"),n.NextResponse.json({error:"No application was updated. Check application ID and permissions."},{status:404});return console.log("âœ… Application status updated successfully:",b),n.NextResponse.json({success:!0,message:"Application status updated successfully",application:b})}catch(e){return console.error("Error updating application status:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let f=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/applications/route",pathname:"/api/applications",filename:"route",bundlePath:"app/api/applications/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/applications/route.js",nextConfigOutput:"",userland:t}),{workAsyncStorage:m,workUnitAsyncStorage:_,serverHooks:j}=f;function b(){return(0,a.patchFetch)({workAsyncStorage:m,workUnitAsyncStorage:_})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var o=e=>r(r.s=e),t=r.X(0,[4243,2307,3605,2190],()=>o(48479));module.exports=t})();