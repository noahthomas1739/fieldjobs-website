(()=>{var e={};e.id=179,e.ids=[179],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},48479:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>g,serverHooks:()=>j,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{GET:()=>u,POST:()=>d});var s=t(96559),i=t(48088),a=t(37719),n=t(32190),p=t(61223),l=t(44999);let c=async(e,r)=>{try{console.log(`ðŸ”” Checking if first application prompt needed for job ${e}`);let{data:t,error:o}=await supabase.from("jobs").select("is_free_job, title, employer_id").eq("id",e).single();if(o||!t)return void console.error("Error fetching job for prompt:",o);if(!t.is_free_job)return void console.log("Job is not a free job, skipping prompt");let{data:s,error:i}=await supabase.from("applications").select("id").eq("job_id",e);if(i)return void console.error("Error checking existing applications:",i);let a=s?.length||0;if(console.log(`ðŸ“Š Application count for job ${e}: ${a}`),1===a){let{data:t,error:o}=await supabase.from("upgrade_prompts").select("id").eq("job_id",e).eq("prompt_type","first_application").single();if(o&&"PGRST116"!==o.code)return void console.error("Error checking existing prompt:",o);if(!t){let{error:t}=await supabase.from("upgrade_prompts").insert({user_id:r,job_id:e,prompt_type:"first_application",triggered_at:new Date().toISOString()});t?console.error("Error creating upgrade prompt:",t):console.log(`âœ… Created first application prompt for job ${e}`)}}}catch(e){console.error("Error in triggerFirstApplicationPrompt:",e)}};async function u(e){try{console.log("\uD83D\uDD0D Applications API called");let{searchParams:r}=new URL(e.url),t=r.get("userId"),o=r.get("employerId");console.log("\uD83D\uDCCB Parameters:",{userId:t,employerId:o});let s=(0,l.UL)(),i=(0,p.createRouteHandlerClient)({cookies:()=>s});if(!t&&!o)return n.NextResponse.json({error:"User ID or Employer ID required"},{status:400});let a=[];if(t){console.log("\uD83D\uDC64 Fetching applications for job seeker:",t);let{data:e,error:r}=await i.from("applications").select(`
          *,
          jobs!inner(id, title, company, employer_id, status)
        `).eq("applicant_id",t).order("applied_at",{ascending:!1});if(r)return console.error("âŒ Error fetching user applications:",r),n.NextResponse.json({error:"Failed to fetch user applications",details:r.message},{status:500});a=e||[],console.log("\uD83D\uDCCA Found",a.length,"applications for user")}else if(o){console.log("\uD83C\uDFE2 Fetching applications for employer:",o);let{data:e,error:r}=await i.from("applications").select(`
          *,
          jobs!inner(id, title, company, employer_id, status)
        `).eq("jobs.employer_id",o).order("applied_at",{ascending:!1});if(r)return console.error("âŒ Error fetching employer applications:",r),n.NextResponse.json({error:"Failed to fetch employer applications",details:r.message},{status:500});a=e||[],console.log("\uD83D\uDCCA Found",a.length,"applications for employer")}return console.log("âœ… Applications fetched successfully"),n.NextResponse.json({success:!0,applications:a,count:a.length})}catch(e){return console.error("\uD83D\uDCA5 Unexpected error in applications API:",e),n.NextResponse.json({error:"Internal server error",details:e.message,stack:void 0},{status:500})}}async function d(e){try{console.log("\uD83D\uDCDD Creating new application");let{jobId:r,userId:t,firstName:o,lastName:s,email:i,phone:a,classification:u}=await e.json(),d=(0,l.UL)(),g=(0,p.createRouteHandlerClient)({cookies:()=>d});if(!r||!t||!o||!s||!i||!a)return n.NextResponse.json({error:"Missing required fields"},{status:400});let{data:f,error:m}=await g.from("applications").select("id").eq("job_id",r).eq("applicant_id",t).single();if(m&&"PGRST116"!==m.code)return console.error("Error checking existing application:",m),n.NextResponse.json({error:"Database error while checking application"},{status:500});if(f)return n.NextResponse.json({error:"You have already applied to this job"},{status:409});let{data:j,error:x}=await g.from("jobs").select("id, title, company, employer_id, is_free_job").eq("id",r).single();if(x)return console.error("Error fetching job:",x),n.NextResponse.json({error:"Job not found"},{status:404});let _={job_id:r,applicant_id:t,first_name:o,last_name:s,email:i,phone:a,classification:u||"",status:"pending",applied_at:new Date().toISOString(),created_at:new Date().toISOString()},{data:b,error:y}=await g.from("applications").insert(_).select().single();if(y)return console.error("Error creating application:",y),n.NextResponse.json({error:"Failed to submit application",details:y.message},{status:500});return console.log("âœ… Application created successfully"),j.is_free_job&&j.employer_id&&await c(r,j.employer_id),n.NextResponse.json({success:!0,message:"Application submitted successfully",application:{id:b.id,job_title:j.title,company:j.company,applied_at:b.applied_at}})}catch(e){return console.error("Error submitting application:",e),n.NextResponse.json({error:"Internal server error"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/applications/route",pathname:"/api/applications",filename:"route",bundlePath:"app/api/applications/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/applications/route.js",nextConfigOutput:"",userland:o}),{workAsyncStorage:f,workUnitAsyncStorage:m,serverHooks:j}=g;function x(){return(0,a.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:m})}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[4243,131,2190],()=>t(48479));module.exports=o})();