(()=>{var e={};e.id=3287,e.ids=[3287],e.modules={759:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>O,routeModule:()=>I,serverHooks:()=>T,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>R});var s={};r.r(s),r.d(s,{POST:()=>p});var o=r(96559),i=r(48088),n=r(37719),a=r(66437),c=r(32190),l=r(81967);let u=(0,a.createClient)(process.env.NEXT_PUBLIC_SUPABASE_URL,process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{autoRefreshToken:!1,persistSession:!1}});function d(e){try{if(null==e)return null;let t=new Date(1e3*e);if(isNaN(t.getTime()))return null;return t.toISOString()}catch(e){return null}}async function p(e){console.log("\uD83D\uDD35 WEBHOOK STARTED");try{let t,r=await e.text(),s=e.headers.get("stripe-signature");if(console.log("âœ… Signature present:",!!s),console.log("âœ… Webhook secret present:",!!process.env.STRIPE_WEBHOOK_SECRET),!s)return console.error("âŒ Missing Stripe signature"),c.NextResponse.json({error:"Missing signature"},{status:400});try{t=l._.webhooks.constructEvent(r,s,process.env.STRIPE_WEBHOOK_SECRET),console.log("âœ… Webhook signature verified successfully")}catch(e){return console.error("âŒ Webhook signature verification failed:",e.message),c.NextResponse.json({error:"Invalid signature"},{status:400})}console.log("\uD83D\uDD35 Received Stripe webhook:",t.type);try{switch(t.type){case"checkout.session.completed":await _(t.data.object);break;case"customer.subscription.created":await m(t.data.object);break;case"customer.subscription.updated":await b(t.data.object);break;case"customer.subscription.deleted":await S(t.data.object);break;case"invoice.payment_failed":await f(t.data.object);break;default:console.log(`ðŸ”µ Unhandled event type: ${t.type}`)}return console.log("âœ… Webhook completed successfully"),c.NextResponse.json({received:!0})}catch(e){return console.error("âŒ Event handler error:",e.message),console.error("âŒ Event handler stack:",e.stack),console.error("âŒ Event type:",t.type),console.error("âŒ Event data:",JSON.stringify(t.data.object,null,2)),c.NextResponse.json({received:!0,error:e.message,note:"Error logged but returning 200 to prevent retry loop"})}}catch(e){return console.error("âŒ WEBHOOK ERROR:",e.message),console.error("âŒ WEBHOOK ERROR STACK:",e.stack),c.NextResponse.json({error:"Webhook failed: "+e.message},{status:500})}}async function _(e){console.log("\uD83D\uDD35 === CHECKOUT COMPLETED ==="),console.log("\uD83D\uDD35 Session mode:",e.mode),console.log("\uD83D\uDD35 Session metadata:",e.metadata),"subscription"===e.mode?(console.log("\uD83D\uDD35 Processing subscription checkout..."),await w(e)):"payment"===e.mode?(console.log("\uD83D\uDD35 Processing one-time payment checkout..."),await g(e)):console.log("\uD83D\uDD35 Unknown checkout mode, skipping")}async function g(e){console.log("\uD83D\uDD35 === ONE-TIME PAYMENT PROCESSING ===");try{let t=e.metadata?.user_id||e.metadata?.userId,r=e.metadata?.addon_type||e.metadata?.featureType,s=e.metadata?.credits_amount,o=e.metadata?.job_id||e.metadata?.jobId;if(console.log("\uD83D\uDD35 Payment metadata:",{userId:t,addonType:r,creditsAmount:s,jobId:o}),console.log("\uD83D\uDD35 Full session metadata:",e.metadata),!t)return void console.error("âŒ No userId found in payment metadata");if(r&&r.startsWith("resume_credits_")){console.log("\uD83D\uDCB0 Processing resume credits purchase...");let o={resume_credits_10:10,resume_credits_25:25,resume_credits_50:50}[r]||parseInt(s)||0;if(0===o)return void console.error("âŒ Invalid credit amount for:",r);console.log(`ðŸ’° Adding ${o} credits to user ${t}`);let{data:i,error:n}=await u.from("credit_balances").select("purchased_credits, monthly_credits").eq("user_id",t).single();if(n&&"PGRST116"===n.code){let{data:e,error:r}=await u.from("credit_balances").insert({user_id:t,purchased_credits:o,monthly_credits:0,last_monthly_refresh:new Date().toISOString().split("T")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(r)throw r;i=e}else if(n)throw n;else{let e=i.purchased_credits+o,{error:r}=await u.from("credit_balances").update({purchased_credits:e,updated_at:new Date().toISOString()}).eq("user_id",t);if(r)throw r;i.purchased_credits=e}await u.from("credit_purchases").insert({user_id:t,credits_purchased:o,package_type:r.split("_")[2],amount_paid:e.amount_total/100,purchased_at:new Date().toISOString(),stripe_session_id:e.id}),console.log(`âœ… Added ${o} credits`)}else if(e.metadata?.payment_type==="single_job"){console.log("\uD83D\uDCBC Processing single job purchase...");let{error:r}=await u.from("stripe_payments").insert({user_id:t,payment_type:"single_job",amount_paid:e.amount_total/100,status:"completed",stripe_session_id:e.id,job_title:e.metadata?.job_title||"Single Job Posting",created_at:new Date().toISOString()});if(r)throw console.error("âŒ Error recording single job payment:",r),r;console.log("âœ… Single job purchase recorded successfully")}else if("featured_listing"===r||"urgent_badge"===r||"featured"===r||"urgent"===r){if(console.log(`ðŸŽ¯ Processing ${r} purchase for job ${o}...`),!o)return void console.error("âŒ No jobId found for feature purchase");let s={updated_at:new Date().toISOString()};"featured_listing"===r||"featured"===r?(s.is_featured=!0,s.featured_until=new Date(Date.now()+2592e6).toISOString(),console.log("\uD83C\uDF1F Setting job as FEATURED until:",s.featured_until)):("urgent_badge"===r||"urgent"===r)&&(s.is_urgent=!0,s.urgent_until=new Date(Date.now()+12096e5).toISOString(),console.log("\uD83D\uDEA8 Setting job as URGENT until:",s.urgent_until));let{data:i,error:n}=await u.from("jobs").update(s).eq("id",o).select();if(n)throw console.error(`âŒ Error updating job with ${r}:`,n),n;console.log(`âœ… Job updated:`,i),await u.from("job_feature_purchases").insert({user_id:t,job_id:o,feature_type:r,amount_paid:e.amount_total/100,purchased_at:new Date().toISOString(),stripe_session_id:e.id}),console.log(`âœ… Applied ${r} to job ${o}`)}console.log("âœ… === ONE-TIME PAYMENT COMPLETED ===")}catch(e){throw console.error("âŒ One-time payment processing error:",e),e}}async function m(e){console.log("\uD83D\uDD35 === SUBSCRIPTION CREATED ===");try{let{data:t}=await u.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).limit(1).single(),r=t?.user_id;if(!r){console.log("\uD83D\uDD0D No existing subscription found, looking up user by customer ID...");let{data:t}=await u.from("profiles").select("id").eq("stripe_customer_id",e.customer).single();if(!t)return void console.log("âŒ No user found for customer ID:",e.customer);r=t.id,console.log("âœ… Found user by customer ID:",r)}await E(e,r),console.log("âœ… Subscription created and synced")}catch(e){throw console.error("âŒ Subscription creation error:",e),e}}async function b(e){console.log("\uD83D\uDD35 === SUBSCRIPTION UPDATED ===");try{let{data:t}=await u.from("subscriptions").select("user_id").eq("stripe_subscription_id",e.id).single();if(t)await E(e,t.user_id);else{let{data:t}=await u.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).single();if(!t)return void console.log("âš ï¸ No subscription found to update, skipping");await E(e,t.user_id)}console.log("âœ… Subscription updated and synced")}catch(e){throw console.error("âŒ Subscription update error:",e),e}}async function S(e){console.log("\uD83D\uDD35 === SUBSCRIPTION DELETED ===");try{await u.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id),console.log("âœ… Subscription marked as cancelled")}catch(e){throw console.error("âŒ Subscription deletion error:",e),e}}async function f(e){console.log("\uD83D\uDD35 === PAYMENT FAILED ===");try{e.subscription&&(await u.from("subscriptions").update({status:"past_due",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.subscription),console.log("âœ… Subscription marked as past_due"))}catch(e){throw console.error("âŒ Payment failure handling error:",e),e}}async function E(e,t){var r;console.log("\uD83D\uDD35 Syncing subscription to database..."),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 User ID:",t);let s=e.items.data[0]?.price?.id,o=(r=s,({[process.env.NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID]:"starter",[process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID]:"growth",[process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID]:"professional",[process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID]:"enterprise"})[r]||"starter");console.log("\uD83D\uDD35 Plan type:",o),console.log("\uD83D\uDD35 Price ID:",s);let i={starter:{active_jobs_limit:3,credits:0,price:19900},growth:{active_jobs_limit:6,credits:5,price:29900},professional:{active_jobs_limit:15,credits:25,price:59900},enterprise:{active_jobs_limit:999999,credits:999999,price:199900}},n=i[o]||i.starter,a={user_id:t,plan_type:o,status:"canceled"===e.status?"cancelled":e.status,stripe_subscription_id:e.id,stripe_customer_id:e.customer,active_jobs_limit:n.active_jobs_limit,credits:n.credits,price:n.price,current_period_start:d(e.current_period_start),current_period_end:d(e.current_period_end),created_at:new Date().toISOString(),updated_at:new Date().toISOString()};"canceled"===e.status&&(a.cancelled_at=d(e.canceled_at)||new Date().toISOString()),console.log("\uD83D\uDD35 Checking if subscription already exists...");let{data:c}=await u.from("subscriptions").select("id").eq("stripe_subscription_id",e.id).single();if(c){console.log("âœ… Subscription already exists, updating...");let{error:t}=await u.from("subscriptions").update(a).eq("stripe_subscription_id",e.id);if(t)throw console.error("âŒ Error updating subscription:",t),t}else{console.log("âœ… Creating new subscription...");let{error:e}=await u.from("subscriptions").insert(a);if(e)throw console.error("âŒ Error inserting subscription:",e),e}console.log("âœ… Subscription synced successfully")}async function w(e){console.log("\uD83D\uDD35 === SUBSCRIPTION HANDLER STARTED ==="),console.log("\uD83D\uDD35 Session ID:",e.id),console.log("\uD83D\uDD35 Session metadata:",JSON.stringify(e.metadata,null,2));try{let t=e.metadata?.userId||e.metadata?.user_id,r=e.metadata?.planType||e.metadata?.plan_type;if(console.log("\uD83D\uDD35 Extracted userId:",t),console.log("\uD83D\uDD35 Extracted planType:",r),!t||!r)throw console.error("âŒ Missing metadata - userId:",t,"planType:",r),Error(`Missing userId or planType in metadata. userId: ${t}, planType: ${r}`);if(!e.subscription)throw console.error("âŒ No subscription ID in session"),Error("No subscription ID in checkout session");console.log("\uD83D\uDD35 Retrieving subscription from Stripe:",e.subscription);let s=await l._.subscriptions.retrieve(e.subscription);console.log("âœ… Subscription retrieved:",s.id),console.log("\uD83D\uDD35 Cleaning up old subscriptions..."),await h(t,s.id),console.log("\uD83D\uDD35 Syncing subscription to database..."),await E(s,t),console.log("âœ… === SUBSCRIPTION HANDLER COMPLETED ===")}catch(e){throw console.error("âŒ === SUBSCRIPTION HANDLER FAILED ==="),console.error("âŒ Error:",e.message),console.error("âŒ Stack:",e.stack),e}}async function h(e,t){console.log("\uD83D\uDD35 Cleaning up old subscriptions..."),await u.from("subscriptions").update({status:"replaced",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("user_id",e).neq("stripe_subscription_id",t).in("status",["active","trialing"]),console.log("âœ… Old subscriptions cleaned up")}let I=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/webhook/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:R,serverHooks:T}=I;function O(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:R})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},81967:(e,t,r)=>{"use strict";r.d(t,{_:()=>s});let s=new(r(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder",{apiVersion:"2023-10-16"})},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,2307,2190,7877],()=>r(759));module.exports=s})();