(()=>{var e={};e.id=3287,e.ids=[3287],e.modules={759:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>R,routeModule:()=>E,serverHooks:()=>h,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>I});var s={};t.r(s),t.d(s,{POST:()=>l});var o=t(96559),i=t(48088),n=t(37719),a=t(32190),c=t(81967);function u(e){try{if(null==e)return null;let r=new Date(1e3*e);if(isNaN(r.getTime()))return null;return r.toISOString()}catch(e){return null}}async function l(e){console.log("\uD83D\uDD35 WEBHOOK STARTED");try{let r,t=await e.text(),s=e.headers.get("stripe-signature");if(console.log("✅ Signature present:",!!s),console.log("✅ Webhook secret present:",!!process.env.STRIPE_WEBHOOK_SECRET),!s)return console.error("❌ Missing Stripe signature"),a.NextResponse.json({error:"Missing signature"},{status:400});try{r=c._.webhooks.constructEvent(t,s,process.env.STRIPE_WEBHOOK_SECRET),console.log("✅ Webhook signature verified successfully")}catch(e){return console.error("❌ Webhook signature verification failed:",e.message),a.NextResponse.json({error:"Invalid signature"},{status:400})}switch(console.log("\uD83D\uDD35 Received Stripe webhook:",r.type),r.type){case"checkout.session.completed":await p(r.data.object);break;case"customer.subscription.created":await d(r.data.object);break;case"customer.subscription.updated":await g(r.data.object);break;case"customer.subscription.deleted":await b(r.data.object);break;case"invoice.payment_failed":await _(r.data.object);break;default:console.log(`🔵 Unhandled event type: ${r.type}`)}return console.log("✅ Webhook completed successfully"),a.NextResponse.json({received:!0})}catch(e){return console.error("❌ WEBHOOK ERROR:",e.message),console.error("❌ WEBHOOK ERROR STACK:",e.stack),a.NextResponse.json({error:"Webhook failed: "+e.message},{status:500})}}async function p(e){console.log("\uD83D\uDD35 === CHECKOUT COMPLETED ==="),"subscription"===e.mode?(console.log("\uD83D\uDD35 Processing subscription checkout..."),await m(e)):console.log("\uD83D\uDD35 Non-subscription checkout, skipping")}async function d(e){console.log("\uD83D\uDD35 === SUBSCRIPTION CREATED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Customer ID:",e.customer),console.log("\uD83D\uDD35 Status:",e.status);try{let{data:r,error:t}=await supabase.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).limit(1).single();if(t&&"PGRST116"!==t.code)throw console.error("❌ Error finding user:",t),Error("Could not find user for customer: "+e.customer);if(!r)return void console.log("⚠️ No existing subscription found for customer, skipping");await S(e,r.user_id),console.log("✅ Subscription created and synced")}catch(e){throw console.error("❌ Subscription creation error:",e),e}}async function g(e){console.log("\uD83D\uDD35 === SUBSCRIPTION UPDATED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Status:",e.status);try{let{data:r,error:t}=await supabase.from("subscriptions").select("user_id").eq("stripe_subscription_id",e.id).single();if(t){console.error("❌ Could not find subscription in database:",t);let{data:r,error:s}=await supabase.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).single();if(s)return void console.log("⚠️ No subscription found to update, skipping");await S(e,r.user_id)}else await S(e,r.user_id);console.log("✅ Subscription updated and synced")}catch(e){throw console.error("❌ Subscription update error:",e),e}}async function b(e){console.log("\uD83D\uDD35 === SUBSCRIPTION DELETED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Customer ID:",e.customer);try{let{error:r}=await supabase.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);if(r)throw console.error("❌ Error marking subscription as cancelled:",r),r;console.log("✅ Subscription marked as cancelled in database");let{error:t}=await supabase.from("subscription_schedule_changes").update({status:"cancelled"}).eq("stripe_schedule_id",e.id);t&&console.log("⚠️ Error cancelling scheduled changes:",t)}catch(e){throw console.error("❌ Subscription deletion error:",e),e}}async function _(e){console.log("\uD83D\uDD35 === PAYMENT FAILED ==="),console.log("\uD83D\uDD35 Invoice ID:",e.id),console.log("\uD83D\uDD35 Subscription ID:",e.subscription);try{if(e.subscription){let{error:r}=await supabase.from("subscriptions").update({status:"past_due",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.subscription);r?console.error("❌ Error updating subscription status:",r):console.log("✅ Subscription marked as past_due")}}catch(e){throw console.error("❌ Payment failure handling error:",e),e}}async function S(e,r){var t;console.log("\uD83D\uDD35 Syncing subscription to database...");let s=(t=e.items.data[0]?.price?.id,({[process.env.NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID]:"starter",[process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID]:"growth",[process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID]:"professional",[process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID]:"enterprise"})[t]||"starter"),o={starter:{active_jobs_limit:3,credits:0,price:19900},growth:{active_jobs_limit:6,credits:5,price:29900},professional:{active_jobs_limit:15,credits:25,price:59900},enterprise:{active_jobs_limit:999999,credits:100,price:199900}},i=o[s]||o.starter,n={plan_type:s,status:"canceled"===e.status?"cancelled":e.status,stripe_subscription_id:e.id,stripe_customer_id:e.customer,active_jobs_limit:i.active_jobs_limit,credits:i.credits,price:i.price,current_period_start:u(e.current_period_start),current_period_end:u(e.current_period_end),updated_at:new Date().toISOString()};"canceled"===e.status&&(n.cancelled_at=u(e.canceled_at)||new Date().toISOString()),console.log("\uD83D\uDD35 Subscription data:",JSON.stringify(n,null,2));let{error:a}=await supabase.from("subscriptions").upsert({user_id:r,...n},{onConflict:"user_id",ignoreDuplicates:!1});if(a)throw console.error("❌ Error syncing subscription:",a),a;console.log("✅ Subscription synced successfully")}async function m(e){console.log("\uD83D\uDD35 === SUBSCRIPTION HANDLER STARTED ===");try{console.log("\uD83D\uDD35 Testing database connection...");let{data:r,error:t}=await supabase.from("subscriptions").select("count").limit(1);if(t)throw console.error("❌ DATABASE CONNECTION FAILED:",t),Error("Database connection failed: "+t.message);console.log("✅ Database connection successful");let s=e.metadata.userId||e.metadata.user_id,o=e.metadata.planType||e.metadata.plan_type;if(console.log("\uD83D\uDD35 User ID from metadata:",s),console.log("\uD83D\uDD35 Plan type from metadata:",o),!s)throw console.error("❌ No userId found in metadata"),Error("Missing userId in metadata");if(!o)throw console.error("❌ No planType found in metadata"),Error("Missing planType in metadata");console.log("\uD83D\uDD35 Retrieving Stripe subscription...");let i=await c._.subscriptions.retrieve(e.subscription);console.log("✅ Stripe subscription retrieved:",i.id),await f(s,i.id),await S(i,s),console.log("✅ === SUBSCRIPTION HANDLER COMPLETED ===")}catch(e){throw console.error("❌ === SUBSCRIPTION HANDLER FAILED ==="),console.error("❌ Handler error:",e.message),console.error("❌ Handler error stack:",e.stack),e}}async function f(e,r){console.log("\uD83D\uDD35 Cleaning up old subscriptions...");let{error:t}=await supabase.from("subscriptions").update({status:"replaced",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("user_id",e).neq("stripe_subscription_id",r).in("status",["active","trialing"]);t?console.error("⚠️ Cleanup error:",t):console.log("✅ Old subscriptions cleaned up")}t(61223),t(44999);let E=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/webhook/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:w,workUnitAsyncStorage:I,serverHooks:h}=E;function R(){return(0,n.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:I})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},81967:(e,r,t)=>{"use strict";t.d(r,{_:()=>s});let s=new(t(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder",{apiVersion:"2023-10-16"})},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[4243,131,2190,7877],()=>t(759));module.exports=s})();