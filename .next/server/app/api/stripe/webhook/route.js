(()=>{var e={};e.id=3287,e.ids=[3287],e.modules={759:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>O,routeModule:()=>I,serverHooks:()=>T,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>R});var o={};r.r(o),r.d(o,{POST:()=>p});var s=r(96559),i=r(48088),n=r(37719),a=r(32190),c=r(81967),l=r(61223),u=r(44999);function d(e){try{if(null==e)return null;let t=new Date(1e3*e);if(isNaN(t.getTime()))return null;return t.toISOString()}catch(e){return null}}async function p(e){console.log("\uD83D\uDD35 WEBHOOK STARTED");try{let t,r=await e.text(),o=e.headers.get("stripe-signature");if(console.log("✅ Signature present:",!!o),console.log("✅ Webhook secret present:",!!process.env.STRIPE_WEBHOOK_SECRET),!o)return console.error("❌ Missing Stripe signature"),a.NextResponse.json({error:"Missing signature"},{status:400});try{t=c._.webhooks.constructEvent(r,o,process.env.STRIPE_WEBHOOK_SECRET),console.log("✅ Webhook signature verified successfully")}catch(e){return console.error("❌ Webhook signature verification failed:",e.message),a.NextResponse.json({error:"Invalid signature"},{status:400})}switch(console.log("\uD83D\uDD35 Received Stripe webhook:",t.type),t.type){case"checkout.session.completed":await _(t.data.object);break;case"customer.subscription.created":await m(t.data.object);break;case"customer.subscription.updated":await b(t.data.object);break;case"customer.subscription.deleted":await f(t.data.object);break;case"invoice.payment_failed":await S(t.data.object);break;default:console.log(`🔵 Unhandled event type: ${t.type}`)}return console.log("✅ Webhook completed successfully"),a.NextResponse.json({received:!0})}catch(e){return console.error("❌ WEBHOOK ERROR:",e.message),console.error("❌ WEBHOOK ERROR STACK:",e.stack),a.NextResponse.json({error:"Webhook failed: "+e.message},{status:500})}}async function _(e){console.log("\uD83D\uDD35 === CHECKOUT COMPLETED ==="),console.log("\uD83D\uDD35 Session mode:",e.mode),console.log("\uD83D\uDD35 Session metadata:",e.metadata),"subscription"===e.mode?(console.log("\uD83D\uDD35 Processing subscription checkout..."),await w(e)):"payment"===e.mode?(console.log("\uD83D\uDD35 Processing one-time payment checkout..."),await g(e)):console.log("\uD83D\uDD35 Unknown checkout mode, skipping")}async function g(e){console.log("\uD83D\uDD35 === ONE-TIME PAYMENT PROCESSING ===");try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),o=e.metadata?.user_id,s=e.metadata?.addon_type,i=e.metadata?.credits_amount,n=e.metadata?.job_id;if(console.log("\uD83D\uDD35 Payment metadata:",{userId:o,addonType:s,creditsAmount:i,jobId:n}),!o)return void console.error("❌ No userId found in payment metadata");if(s&&s.startsWith("resume_credits_")){console.log("\uD83D\uDCB0 Processing resume credits purchase...");let t={resume_credits_10:10,resume_credits_25:25,resume_credits_50:50}[s]||parseInt(i)||0;if(0===t)return void console.error("❌ Invalid credit amount for:",s);console.log(`💰 Adding ${t} credits to user ${o}`);let{data:n,error:a}=await r.from("credit_balances").select("purchased_credits, monthly_credits").eq("user_id",o).single();if(a&&"PGRST116"===a.code){console.log("\uD83D\uDCB0 Creating new credit balance record...");let{data:e,error:s}=await r.from("credit_balances").insert({user_id:o,purchased_credits:t,monthly_credits:0,last_monthly_refresh:new Date().toISOString().split("T")[0],created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();if(s)throw console.error("❌ Error creating credit balance:",s),s;n=e}else if(a)throw console.error("❌ Error fetching credit balance:",a),a;else{console.log("\uD83D\uDCB0 Updating existing credit balance...");let e=n.purchased_credits+t,{error:s}=await r.from("credit_balances").update({purchased_credits:e,updated_at:new Date().toISOString()}).eq("user_id",o);if(s)throw console.error("❌ Error updating credit balance:",s),s;n.purchased_credits=e}let{error:c}=await r.from("credit_purchases").insert({user_id:o,credits_purchased:t,package_type:s.split("_")[2],amount_paid:e.amount_total/100,purchased_at:new Date().toISOString(),stripe_session_id:e.id});c&&console.warn("⚠️ Failed to log credit purchase:",c);let l=n.monthly_credits+n.purchased_credits;console.log(`✅ Added ${t} credits. Total credits: ${l}`)}else if("featured_listing"===s||"urgent_badge"===s){if(console.log(`🎯 Processing ${s} purchase for job ${n}...`),!n)return void console.error("❌ No jobId found for feature purchase");let t={updated_at:new Date().toISOString()};"featured_listing"===s?(t.is_featured=!0,t.featured_until=new Date(Date.now()+2592e6).toISOString()):"urgent_badge"===s&&(t.is_urgent=!0,t.urgent_until=new Date(Date.now()+12096e5).toISOString());let{error:i}=await r.from("jobs").update(t).eq("id",n).eq("user_id",o);if(i)throw console.error(`❌ Error updating job with ${s}:`,i),i;let{error:a}=await r.from("job_feature_purchases").insert({user_id:o,job_id:n,feature_type:s,amount_paid:e.amount_total/100,purchased_at:new Date().toISOString(),stripe_session_id:e.id});a&&console.warn("⚠️ Failed to log feature purchase:",a),console.log(`✅ Applied ${s} to job ${n}`)}console.log("✅ === ONE-TIME PAYMENT COMPLETED ===")}catch(e){throw console.error("❌ One-time payment processing error:",e),e}}async function m(e){console.log("\uD83D\uDD35 === SUBSCRIPTION CREATED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Customer ID:",e.customer),console.log("\uD83D\uDD35 Status:",e.status);try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:o,error:s}=await r.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).limit(1).single();if(s&&"PGRST116"!==s.code)throw console.error("❌ Error finding user:",s),Error("Could not find user for customer: "+e.customer);if(!o)return void console.log("⚠️ No existing subscription found for customer, skipping");await h(e,o.user_id),console.log("✅ Subscription created and synced")}catch(e){throw console.error("❌ Subscription creation error:",e),e}}async function b(e){console.log("\uD83D\uDD35 === SUBSCRIPTION UPDATED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Status:",e.status);try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:o,error:s}=await r.from("subscriptions").select("user_id").eq("stripe_subscription_id",e.id).single();if(s){console.error("❌ Could not find subscription in database:",s);let{data:t,error:o}=await r.from("subscriptions").select("user_id").eq("stripe_customer_id",e.customer).single();if(o)return void console.log("⚠️ No subscription found to update, skipping");await h(e,t.user_id)}else await h(e,o.user_id);console.log("✅ Subscription updated and synced")}catch(e){throw console.error("❌ Subscription update error:",e),e}}async function f(e){console.log("\uD83D\uDD35 === SUBSCRIPTION DELETED ==="),console.log("\uD83D\uDD35 Subscription ID:",e.id),console.log("\uD83D\uDD35 Customer ID:",e.customer);try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),{error:o}=await r.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.id);if(o)throw console.error("❌ Error marking subscription as cancelled:",o),o;console.log("✅ Subscription marked as cancelled in database");let{error:s}=await r.from("subscription_schedule_changes").update({status:"cancelled"}).eq("stripe_schedule_id",e.id);s&&console.log("⚠️ Error cancelling scheduled changes:",s)}catch(e){throw console.error("❌ Subscription deletion error:",e),e}}async function S(e){console.log("\uD83D\uDD35 === PAYMENT FAILED ==="),console.log("\uD83D\uDD35 Invoice ID:",e.id),console.log("\uD83D\uDD35 Subscription ID:",e.subscription);try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t});if(e.subscription){let{error:t}=await r.from("subscriptions").update({status:"past_due",updated_at:new Date().toISOString()}).eq("stripe_subscription_id",e.subscription);t?console.error("❌ Error updating subscription status:",t):console.log("✅ Subscription marked as past_due")}}catch(e){throw console.error("❌ Payment failure handling error:",e),e}}async function h(e,t){var r;console.log("\uD83D\uDD35 Syncing subscription to database...");let o=(0,u.UL)(),s=(0,l.createRouteHandlerClient)({cookies:()=>o}),i=(r=e.items.data[0]?.price?.id,({[process.env.NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID]:"starter",[process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID]:"growth",[process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID]:"professional",[process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID]:"enterprise"})[r]||"starter"),n={starter:{active_jobs_limit:3,credits:0,price:19900},growth:{active_jobs_limit:6,credits:5,price:29900},professional:{active_jobs_limit:15,credits:25,price:59900},enterprise:{active_jobs_limit:999999,credits:100,price:199900}},a=n[i]||n.starter,c={plan_type:i,status:"canceled"===e.status?"cancelled":e.status,stripe_subscription_id:e.id,stripe_customer_id:e.customer,active_jobs_limit:a.active_jobs_limit,credits:a.credits,price:a.price,current_period_start:d(e.current_period_start),current_period_end:d(e.current_period_end),updated_at:new Date().toISOString()};"canceled"===e.status&&(c.cancelled_at=d(e.canceled_at)||new Date().toISOString()),console.log("\uD83D\uDD35 Subscription data:",JSON.stringify(c,null,2));let{error:p}=await s.from("subscriptions").upsert({user_id:t,...c},{onConflict:"user_id",ignoreDuplicates:!1});if(p)throw console.error("❌ Error syncing subscription:",p),p;console.log("✅ Subscription synced successfully")}async function w(e){console.log("\uD83D\uDD35 === SUBSCRIPTION HANDLER STARTED ===");try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t});console.log("\uD83D\uDD35 Testing database connection...");let{data:o,error:s}=await r.from("subscriptions").select("count").limit(1);if(s)throw console.error("❌ DATABASE CONNECTION FAILED:",s),Error("Database connection failed: "+s.message);console.log("✅ Database connection successful");let i=e.metadata.userId||e.metadata.user_id,n=e.metadata.planType||e.metadata.plan_type;if(console.log("\uD83D\uDD35 User ID from metadata:",i),console.log("\uD83D\uDD35 Plan type from metadata:",n),!i)throw console.error("❌ No userId found in metadata"),Error("Missing userId in metadata");if(!n)throw console.error("❌ No planType found in metadata"),Error("Missing planType in metadata");console.log("\uD83D\uDD35 Retrieving Stripe subscription...");let a=await c._.subscriptions.retrieve(e.subscription);console.log("✅ Stripe subscription retrieved:",a.id),await E(i,a.id),await h(a,i),console.log("✅ === SUBSCRIPTION HANDLER COMPLETED ===")}catch(e){throw console.error("❌ === SUBSCRIPTION HANDLER FAILED ==="),console.error("❌ Handler error:",e.message),console.error("❌ Handler error stack:",e.stack),e}}async function E(e,t){console.log("\uD83D\uDD35 Cleaning up old subscriptions...");let r=(0,u.UL)(),o=(0,l.createRouteHandlerClient)({cookies:()=>r}),{error:s}=await o.from("subscriptions").update({status:"replaced",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("user_id",e).neq("stripe_subscription_id",t).in("status",["active","trialing"]);s?console.error("⚠️ Cleanup error:",s):console.log("✅ Old subscriptions cleaned up")}let I=new s.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/webhook/route.js",nextConfigOutput:"",userland:o}),{workAsyncStorage:y,workUnitAsyncStorage:R,serverHooks:T}=I;function O(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:R})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},81967:(e,t,r)=>{"use strict";r.d(t,{_:()=>o});let o=new(r(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder",{apiVersion:"2023-10-16"})},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[4243,131,2190,1330,7877],()=>r(759));module.exports=o})();