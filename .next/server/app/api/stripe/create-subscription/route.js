(()=>{var e={};e.id=4862,e.ids=[4862],e.modules={1858:(e,s,r)=>{"use strict";r.r(s),r.d(s,{patchFetch:()=>_,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>g});var t={};r.r(t),r.d(t,{POST:()=>l});var o=r(96559),i=r(48088),n=r(37719),a=r(32190);r(61223),r(44999);var c=r(97877);console.log("=== CREATE SUBSCRIPTION ROUTE STARTED ==="),console.log("Environment check:",{hasSupabaseUrl:!0,hasSupabaseKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasStripeKey:!!process.env.STRIPE_SECRET_KEY,hasBaseUrl:!!process.env.NEXT_PUBLIC_BASE_URL,hasGrowth:!!process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID,hasProfessional:!!process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID,hasEnterprise:!!process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID,nodeEnv:"production"});let u=new c.A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");async function l(e){console.log("=== POST REQUEST RECEIVED ===");try{console.log("Parsing request body...");let{priceId:s,planType:r,userId:t}=await e.json();if(console.log("Request data:",{priceId:s,planType:r,userId:t}),!t||!s||!r)return console.log("Missing fields:",{userId:!!t,priceId:!!s,planType:!!r}),a.NextResponse.json({error:"Missing required fields"},{status:400});console.log("Checking existing subscriptions...");let{data:o,error:i}=await supabase.from("subscriptions").select("*").eq("user_id",t).eq("status","active");if(i)return console.error("❌ Supabase subscription check error:",i),a.NextResponse.json({error:"Failed to check existing subscriptions",details:i.message},{status:500});if(console.log("Existing subscriptions found:",o?.length||0),o&&o.length>0){let e=o[0];return console.log("\uD83D\uDEAB Active subscription found:",e.plan_type),a.NextResponse.json({error:"You already have an active subscription",currentPlan:e.plan_type,message:`You currently have an active ${e.plan_type} plan. Please use the upgrade/downgrade options instead of purchasing a new subscription.`,shouldUpgrade:!0},{status:400})}console.log("Getting user profile...");let{data:n,error:c}=await supabase.from("profiles").select("stripe_customer_id, email").eq("id",t).single();if(c)return console.error("❌ Profile error:",c),a.NextResponse.json({error:"User profile not found",details:c.message},{status:404});console.log("User profile:",{hasCustomerId:!!n?.stripe_customer_id,email:n?.email});let l=n?.stripe_customer_id;if(l){console.log("Verifying existing customer in Stripe...");try{(await u.customers.retrieve(l)).deleted?(console.log("⚠️ Customer is deleted, will create new one"),l=null):console.log("✅ Existing customer verified:",l)}catch(e){console.log("⚠️ Customer not found in Stripe:",e.message),l=null}}if(l){console.log("Checking Stripe for active subscriptions...");try{let e=await u.subscriptions.list({customer:l,status:"active"});if(e.data.length>0)return console.log("\uD83D\uDEAB Found active subscription in Stripe:",e.data[0].id),a.NextResponse.json({error:"Active subscription found in Stripe",message:"You have an active subscription. Please use upgrade/downgrade options.",shouldUpgrade:!0},{status:400})}catch(e){console.log("⚠️ Could not check Stripe subscriptions:",e.message)}}if(!l){console.log("Creating/finding customer...");try{let e=await u.customers.list({email:n.email,limit:10});if(e.data.length>0){let s=e.data.find(e=>!e.deleted);s&&(l=s.id,console.log("✅ Found existing customer:",l),await supabase.from("profiles").update({stripe_customer_id:l}).eq("id",t))}l||(console.log("Creating new customer..."),l=(await u.customers.create({email:n.email,metadata:{userId:t,createdBy:"fieldjobs-app",createdAt:new Date().toISOString()}})).id,console.log("✅ Created new customer:",l),await supabase.from("profiles").update({stripe_customer_id:l}).eq("id",t))}catch(e){return console.error("❌ Customer creation failed:",e),a.NextResponse.json({error:"Failed to create customer",details:e.message},{status:500})}}console.log("Creating checkout session..."),console.log("Session config:",{customerId:l,priceId:s,planType:r,baseUrl:process.env.NEXT_PUBLIC_BASE_URL});let p=await u.checkout.sessions.create({customer:l,payment_method_types:["card"],line_items:[{price:s,quantity:1}],mode:"subscription",success_url:`${process.env.NEXT_PUBLIC_BASE_URL}/employer?success=true&plan=${r}`,cancel_url:`${process.env.NEXT_PUBLIC_BASE_URL}/employer?canceled=true`,metadata:{userId:t,planType:r,isNewSubscription:"true"},subscription_data:{metadata:{userId:t,planType:r}},allow_promotion_codes:!1});return console.log("✅ Checkout session created successfully:",p.id),a.NextResponse.json({sessionId:p.id,url:p.url})}catch(e){return console.error("❌ FATAL ERROR in create-subscription:",e),console.error("Error stack:",e.stack),a.NextResponse.json({error:"Failed to create checkout session",details:e.message,stack:void 0},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stripe/create-subscription/route",pathname:"/api/stripe/create-subscription",filename:"route",bundlePath:"app/api/stripe/create-subscription/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/create-subscription/route.js",nextConfigOutput:"",userland:t}),{workAsyncStorage:d,workUnitAsyncStorage:g,serverHooks:m}=p;function _(){return(0,n.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:g})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var s=require("../../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[4243,131,2190,7877],()=>r(1858));module.exports=t})();