(()=>{var e={};e.id=4862,e.ids=[4862],e.modules={1858:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>f,routeModule:()=>m,serverHooks:()=>b,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>_});var r={};s.r(r),s.d(r,{POST:()=>d});var i=s(96559),o=s(48088),n=s(37719),a=s(32190),c=s(61223),l=s(44999),p=s(97877);console.log("=== CREATE SUBSCRIPTION ROUTE STARTED ==="),console.log("Environment check:",{hasSupabaseUrl:!!process.env.NEXT_PUBLIC_SUPABASE_URL,hasSupabaseKey:!!process.env.SUPABASE_SERVICE_ROLE_KEY,hasStripeKey:!!process.env.STRIPE_SECRET_KEY,hasBaseUrl:!!process.env.NEXT_PUBLIC_BASE_URL,hasGrowth:!!process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID,hasProfessional:!!process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID,hasEnterprise:!!process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID,nodeEnv:"production"});let u=new p.A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");async function d(e){console.log("=== POST REQUEST RECEIVED ===");try{let t,s=(0,l.UL)(),r=(0,c.createRouteHandlerClient)({cookies:()=>s});console.log("Parsing request body...");let{priceId:i,planType:o,userId:n}=await e.json();if(console.log("Request data:",{priceId:i,planType:o,userId:n}),!n||!o)return console.log("Missing fields:",{userId:!!n,planType:!!o}),a.NextResponse.json({error:"Missing required fields"},{status:400});let p=i;if(!p){if(console.log("No priceId provided, using dynamic pricing for plan:",o),!({starter:{amount:19900,name:"Starter Plan",description:"3 active jobs, basic features"},growth:{amount:29900,name:"Growth Plan",description:"6 active jobs, 5 monthly credits"},professional:{amount:59900,name:"Professional Plan",description:"15 active jobs, 25 monthly credits"},enterprise:{amount:199900,name:"Enterprise Plan",description:"Unlimited jobs, 100 monthly credits"}})[o])return a.NextResponse.json({error:"Invalid plan type"},{status:400});p=null}console.log("Checking existing subscriptions...");let{data:d,error:m}=await r.from("subscriptions").select("*").eq("user_id",n).eq("status","active");if(m)return console.error("❌ Supabase subscription check error:",m),a.NextResponse.json({error:"Failed to check existing subscriptions",details:m.message},{status:500});if(console.log("Existing subscriptions found:",d?.length||0),d&&d.length>0){let e=d[0];return console.log("\uD83D\uDEAB Active subscription found:",e.plan_type),a.NextResponse.json({error:"Active subscription found in Stripe",currentPlan:e.plan_type,message:"You have an active subscription. Please use upgrade/downgrade options.",shouldUpgrade:!0,redirectToBilling:!0},{status:400})}console.log("Getting user profile...");let{data:g,error:_}=await r.from("profiles").select("stripe_customer_id, email").eq("id",n).single();if(_)return console.error("❌ Profile error:",_),a.NextResponse.json({error:"User profile not found",details:_.message},{status:404});console.log("User profile:",{hasCustomerId:!!g?.stripe_customer_id,email:g?.email});let b=g?.stripe_customer_id;if(b){console.log("Verifying existing customer in Stripe...");try{(await u.customers.retrieve(b)).deleted?(console.log("⚠️ Customer is deleted, will create new one"),b=null):console.log("✅ Existing customer verified:",b)}catch(e){console.log("⚠️ Customer not found in Stripe:",e.message),b=null}}if(b){console.log("Checking Stripe for active subscriptions...");try{let e=await u.subscriptions.list({customer:b,status:"active"});if(e.data.length>0){let t=e.data[0];console.log("\uD83D\uDEAB Found active subscription in Stripe:",t.id),console.log("\uD83D\uDD04 Syncing missing subscription from Stripe to database...");try{let e={19900:{planType:"starter",price:19900,jobLimit:3,credits:0},29900:{planType:"growth",price:29900,jobLimit:6,credits:5},59900:{planType:"professional",price:59900,jobLimit:15,credits:25},199900:{planType:"enterprise",price:199900,jobLimit:999999,credits:100}}[t.items.data[0]?.price?.unit_amount||0]||{planType:"starter",price:19900,jobLimit:3,credits:0},{data:s}=await r.from("subscriptions").select("id").eq("user_id",n).eq("stripe_subscription_id",t.id).single();if(s)console.log("✅ Subscription already exists in database");else{let{error:s}=await r.from("subscriptions").insert({user_id:n,stripe_customer_id:b,stripe_subscription_id:t.id,plan_type:e.planType,status:"active",price:e.price,active_jobs_limit:e.jobLimit,credits:e.credits,current_period_start:new Date(1e3*t.current_period_start).toISOString(),current_period_end:new Date(1e3*t.current_period_end).toISOString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()});s?console.error("⚠️ Failed to insert subscription:",s):console.log("✅ Subscription synced to database")}}catch(e){console.error("⚠️ Failed to sync subscription to database:",e)}return a.NextResponse.json({error:"Active subscription found in Stripe",message:"You have an active subscription. Please use upgrade/downgrade options.",shouldUpgrade:!0,redirectToBilling:!0},{status:400})}}catch(e){console.log("⚠️ Could not check Stripe subscriptions:",e.message)}}if(!b){console.log("Creating/finding customer...");try{let e=await u.customers.list({email:g.email,limit:10});if(e.data.length>0){let t=e.data.find(e=>!e.deleted);t&&(b=t.id,console.log("✅ Found existing customer:",b),await r.from("profiles").update({stripe_customer_id:b}).eq("id",n))}b||(console.log("Creating new customer..."),b=(await u.customers.create({email:g.email,metadata:{userId:n,createdBy:"fieldjobs-app",createdAt:new Date().toISOString()}})).id,console.log("✅ Created new customer:",b),await r.from("profiles").update({stripe_customer_id:b}).eq("id",n))}catch(e){return console.error("❌ Customer creation failed:",e),a.NextResponse.json({error:"Failed to create customer",details:e.message},{status:500})}}if(console.log("Creating checkout session..."),console.log("Session config:",{customerId:b,priceId:p,planType:o,baseUrl:process.env.NEXT_PUBLIC_BASE_URL}),p)t={price:p,quantity:1};else{let e={starter:{amount:19900,name:"Starter Plan",description:"3 active jobs, basic features"},growth:{amount:29900,name:"Growth Plan",description:"6 active jobs, 5 monthly credits"},professional:{amount:59900,name:"Professional Plan",description:"15 active jobs, 25 monthly credits"},enterprise:{amount:199900,name:"Enterprise Plan",description:"Unlimited jobs, 100 monthly credits"}}[o];t={price_data:{currency:"usd",product_data:{name:e.name,description:e.description},unit_amount:e.amount,recurring:{interval:"month"}},quantity:1}}let f=await u.checkout.sessions.create({customer:b,payment_method_types:["card"],line_items:[t],mode:"subscription",success_url:`${process.env.NEXT_PUBLIC_BASE_URL}/employer?success=true&plan=${o}`,cancel_url:`${process.env.NEXT_PUBLIC_BASE_URL}/employer?canceled=true`,metadata:{userId:n,planType:o,isNewSubscription:"true"},subscription_data:{metadata:{userId:n,planType:o}},allow_promotion_codes:!1});return console.log("✅ Checkout session created successfully:",f.id),a.NextResponse.json({sessionId:f.id,url:f.url})}catch(e){return console.error("❌ FATAL ERROR in create-subscription:",e),console.error("Error stack:",e.stack),a.NextResponse.json({error:"Failed to create checkout session",details:e.message,stack:void 0},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/stripe/create-subscription/route",pathname:"/api/stripe/create-subscription",filename:"route",bundlePath:"app/api/stripe/create-subscription/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/create-subscription/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:_,serverHooks:b}=m;function f(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:_})}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[4243,2307,3605,2190,7877],()=>s(1858));module.exports=r})();