(()=>{var e={};e.id=9889,e.ids=[9889],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9270:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>R,routeModule:()=>x,serverHooks:()=>N,workAsyncStorage:()=>j,workUnitAsyncStorage:()=>q});var s={};r.r(s),r.d(s,{POST:()=>_});var i=r(96559),o=r(48088),n=r(37719),a=r(32190),c=r(97877),l=r(61223),u=r(44999);let d=new c.A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");function p(e){try{if(null==e)return null;let t=new Date(1e3*e);if(isNaN(t.getTime()))return null;return t.toISOString()}catch(e){return null}}async function _(e){try{let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),{action:s,userId:i,newPriceId:o,newPlanType:n,subscriptionId:c}=await e.json();if(console.log("\uD83D\uDD27 Managing subscription:",{action:s,userId:i,newPriceId:o,newPlanType:n,subscriptionId:c}),!i)return a.NextResponse.json({error:"User ID is required"},{status:400});if("get_billing_portal"===s)return await S(r,i);if("get_billing_history"===s)return await D(i);let d=await g(r,i);if(!d)return a.NextResponse.json({error:"No valid subscription found",shouldCreateNew:!0,message:"Please create a new subscription to continue."},{status:404});switch(console.log("\uD83D\uDCCA Valid subscription found:",{id:d.id,stripeId:d.stripe_subscription_id,planType:d.plan_type,status:d.status}),s){case"upgrade_immediate":return await b(r,d,o,n);case"downgrade_end_cycle":return await h(r,d,o,n);case"cancel":return await w(r,d);case"reactivate":return await y(r,d);case"get_billing_history":return await D(i);default:return a.NextResponse.json({error:"Invalid action"},{status:400})}}catch(e){return console.error("âŒ Subscription management error:",e),a.NextResponse.json({error:"Subscription management failed",details:e.message,shouldCreateNew:e.message.includes("No such subscription")},{status:500})}}async function g(e,t){console.log("\uD83D\uDD0D Finding valid subscription for user:",t);let{data:r,error:s}=await e.from("subscriptions").select("*").eq("user_id",t).order("created_at",{ascending:!1});if(s)throw console.error("âŒ Database error:",s),Error("Database query failed: "+s.message);if(!r||0===r.length)return console.log("âŒ No subscriptions found in database"),null;for(let t of(console.log(`ðŸ“Š Found ${r.length} subscription(s) in database:`),r.forEach((e,t)=>{console.log(`  ${t+1}. ID: ${e.id}, Stripe: ${e.stripe_subscription_id}, Status: ${e.status}, Plan: ${e.plan_type}`)}),r)){if(console.log(`
ðŸ” Validating subscription ${t.id}:`),console.log(`  - Stripe ID: ${t.stripe_subscription_id}`),console.log(`  - DB Status: ${t.status}`),console.log(`  - Plan Type: ${t.plan_type}`),console.log(`  - Created: ${t.created_at}`),!t.stripe_subscription_id){console.log("âš ï¸ Skipping - no Stripe subscription ID");continue}try{console.log(`ðŸ”— Calling Stripe API for subscription: ${t.stripe_subscription_id}`);let r=await d.subscriptions.retrieve(t.stripe_subscription_id);console.log("âœ… Stripe API response successful:"),console.log(`  - Stripe Status: ${r.status}`),console.log(`  - Customer: ${r.customer}`);{let e=r.items?.data?.[0],t=p(e?.current_period_start),s=p(e?.current_period_end);console.log(`  - Current Period: ${t||"unknown"} to ${s||"unknown"}`)}console.log(`  - Items: ${r.items?.data?.length||0}`),await f(e,t,r);let s=["active","trialing","past_due","unpaid"];if(s.includes(r.status))return console.log("âœ… Found valid subscription with status:",r.status),{...t,stripeData:r};console.log(`âš ï¸ Subscription ${r.id} status "${r.status}" not in valid statuses: ${s.join(", ")}`)}catch(r){console.error(`âŒ Stripe validation failed for ${t.stripe_subscription_id}:`),console.error(`  - Error Type: ${r.type}`),console.error(`  - Error Code: ${r.code}`),console.error(`  - Error Message: ${r.message}`),r.message.includes("No such subscription")&&(console.log(`ðŸ—‘ï¸ Marking subscription as invalid due to Stripe error`),await m(e,t.id));continue}}return console.log("âŒ No valid active subscriptions found after checking all records"),null}async function f(e,t,r){let s=t.status,i=r.status;if(s!==i){console.log(`ðŸ”„ Syncing status: DB="${s}" -> Stripe="${i}"`);let o={status:"canceled"===i?"cancelled":i,current_period_start:p(r.current_period_start),current_period_end:p(r.current_period_end),updated_at:new Date().toISOString()};"canceled"===i&&(r.canceled_at?o.cancelled_at=p(r.canceled_at)||new Date().toISOString():t.cancelled_at||(o.cancelled_at=new Date().toISOString()));let{error:n}=await e.from("subscriptions").update(o).eq("id",t.id);n?console.error("âš ï¸ Failed to sync status:",n):console.log("âœ… Status synced successfully")}}async function m(e,t){console.log(`ðŸ—‘ï¸ Marking subscription ${t} as invalid`);let{error:r}=await e.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t);r?console.error("âš ï¸ Failed to mark as invalid:",r):console.log("âœ… Marked subscription as cancelled (invalid)")}async function b(e,t,r,s){try{console.log("â¬†ï¸ Starting immediate upgrade...");let i=t.stripeData;if(!["active","trialing"].includes(i.status))throw Error(`Cannot upgrade ${i.status} subscription`);if(!i.items?.data?.[0])throw Error("No subscription items found");if(!r||!s)throw Error("Missing price ID or plan type");console.log("\uD83D\uDCB0 Updating Stripe subscription...");let o=await d.subscriptions.update(i.id,{items:[{id:i.items.data[0].id,price:r}],proration_behavior:"create_prorations",billing_cycle_anchor:"unchanged"});console.log("âœ… Stripe subscription updated successfully");let n=$(s),{error:c}=await e.from("subscriptions").update({plan_type:n.planType,price:n.price,active_jobs_limit:n.jobLimit,credits:n.credits,current_period_start:p(o.current_period_start),current_period_end:p(o.current_period_end),status:"active",cancelled_at:null,updated_at:new Date().toISOString()}).eq("id",t.id);if(c)throw console.error("âŒ Database update error:",c),Error("Database update failed: "+c.message);return await v(e,t.user_id,i.id),a.NextResponse.json({success:!0,message:`Successfully upgraded to ${n.planType} plan!`,newPlan:n})}catch(e){return console.error("âŒ Upgrade error:",e),a.NextResponse.json({success:!1,error:"Upgrade failed",details:e.message},{status:500})}}async function h(e,t,r,s){try{console.log("â¬‡ï¸ Starting end-cycle downgrade...");let r=t.stripeData;if(!["active","trialing"].includes(r.status))throw Error(`Cannot downgrade ${r.status} subscription`);let{data:i}=await e.from("subscription_schedule_changes").select("*").eq("user_id",t.user_id).eq("status","scheduled").single();if(i)return a.NextResponse.json({success:!1,error:"Downgrade already scheduled",message:`You already have a scheduled downgrade to ${i.new_plan} plan.`},{status:400});let o=$(s);$(t.plan_type);let{data:n,error:c}=await e.from("jobs").select("id, title").eq("user_id",t.user_id).eq("active",!0).neq("status","deleted");if(!c&&n){let e=n.length,t=o.jobLimit;if(console.log(`ðŸ“Š Job slots check: ${e} active jobs, new limit: ${t}`),e>t){let r=e-t;return a.NextResponse.json({success:!1,error:"Too many active jobs",message:`You currently have ${e} active job${e>1?"s":""}, but the ${o.planType} plan only allows ${t}. Please deactivate ${r} job${r>1?"s":""} before downgrading.`,activeJobCount:e,newJobLimit:t,excessJobs:r,requiresAction:!0},{status:400})}}console.log("\uD83D\uDC1B DEBUG stripeSubscription.current_period_end:",r.current_period_end),console.log("\uD83D\uDC1B DEBUG stripeSubscription.items.data[0]?.current_period_end:",r.items?.data?.[0]?.current_period_end);let l=r.current_period_end||r.items?.data?.[0]?.current_period_end;console.log("\uD83D\uDC1B DEBUG final periodEnd value:",l);let u=p(l);if(console.log("\uD83D\uDC1B DEBUG effectiveDate after conversion:",u),!u&&l){console.log("\uD83D\uDD27 Trying direct Date conversion as fallback...");try{let r=new Date(1e3*l).toISOString();console.log("\uD83D\uDD27 Fallback conversion successful:",r);let{error:s}=await e.from("subscription_schedule_changes").insert({user_id:t.user_id,subscription_id:t.id,stripe_schedule_id:`manual_${Date.now()}`,current_plan:t.plan_type,new_plan:o.planType,effective_date:r,status:"scheduled"});if(s)throw console.error("âŒ Schedule error:",s),Error("Failed to schedule downgrade: "+s.message);return a.NextResponse.json({success:!0,message:`Downgrade scheduled to ${o.planType} plan! Your current benefits continue until ${new Date(r).toLocaleDateString()}.`,effectiveDate:r,newPlan:o})}catch(e){throw console.error("âŒ Fallback conversion also failed:",e),Error("Unable to determine billing period end date from Stripe. Please contact support.")}}if(!u)throw Error("Unable to determine billing period end date from Stripe. Please contact support.");let{error:d}=await e.from("subscription_schedule_changes").insert({user_id:t.user_id,subscription_id:t.id,stripe_schedule_id:`manual_${Date.now()}`,current_plan:t.plan_type,new_plan:o.planType,effective_date:u,status:"scheduled"});if(d)throw console.error("âŒ Schedule error:",d),Error("Failed to schedule downgrade: "+d.message);return a.NextResponse.json({success:!0,message:`Downgrade scheduled to ${o.planType} plan! Your current benefits continue until ${u?new Date(u).toLocaleDateString():"the end of your current period"}.`,effectiveDate:u,newPlan:o})}catch(e){return console.error("âŒ Downgrade error:",e),a.NextResponse.json({success:!1,error:"Downgrade scheduling failed",details:e.message},{status:500})}}async function w(e,t){try{console.log("âŒ Cancelling subscription...");let r=t.stripeData,s=await d.subscriptions.update(r.id,{cancel_at_period_end:!0}),{error:i}=await e.from("subscriptions").update({status:"cancelled",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t.id);if(i)throw Error("Database update failed: "+i.message);return a.NextResponse.json({success:!0,message:"Subscription will cancel at the end of your billing period",cancelAt:p(s.current_period_end)})}catch(e){return console.error("âŒ Cancel error:",e),a.NextResponse.json({success:!1,error:"Cancellation failed",details:e.message},{status:500})}}async function y(e,t){try{console.log("\uD83D\uDD04 Reactivating subscription...");let r=t.stripeData;await d.subscriptions.update(r.id,{cancel_at_period_end:!1});let{error:s}=await e.from("subscriptions").update({status:"active",cancelled_at:null,updated_at:new Date().toISOString()}).eq("id",t.id);if(s)throw Error("Database update failed: "+s.message);return a.NextResponse.json({success:!0,message:"Subscription reactivated successfully"})}catch(e){return console.error("âŒ Reactivate error:",e),a.NextResponse.json({success:!1,error:"Reactivation failed",details:e.message},{status:500})}}async function v(e,t,r){console.log("\uD83E\uDDF9 Cleaning up old subscriptions...");let{error:s}=await e.from("subscriptions").update({status:"replaced",cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("user_id",t).neq("stripe_subscription_id",r).in("status",["active","trialing"]);s?console.error("âš ï¸ Cleanup error:",s):console.log("âœ… Old subscriptions cleaned up")}async function S(e,t){try{console.log("\uD83D\uDD17 Creating billing portal session for user:",t);let r=null,{data:s}=await e.from("subscriptions").select("stripe_customer_id").eq("user_id",t).order("created_at",{ascending:!1}).limit(1).single();if(s?.stripe_customer_id)r=s.stripe_customer_id,console.log("âœ… Found customer ID from subscription:",r);else{console.log("âš ï¸ No subscription found, checking profile...");let{data:s}=await e.from("profiles").select("stripe_customer_id").eq("id",t).single();s?.stripe_customer_id&&(r=s.stripe_customer_id,console.log("âœ… Found customer ID from profile:",r))}if(!r)return console.error("âŒ No Stripe customer ID found for user:",t),a.NextResponse.json({error:"No billing information found",message:"No payment method on file. Please upgrade to a paid plan first to manage payment methods.",requiresSubscription:!0},{status:404});console.log("âœ… Creating Stripe billing portal for customer:",r);let i=await d.billingPortal.sessions.create({customer:r,return_url:`${process.env.NEXT_PUBLIC_BASE_URL}/employer?tab=subscription`});return console.log("âœ… Billing portal session created:",i.id),a.NextResponse.json({success:!0,url:i.url})}catch(e){return console.error("âŒ Billing portal error:",e),a.NextResponse.json({error:"Failed to create billing portal session",details:e.message},{status:500})}}async function D(e){try{console.log("\uD83D\uDCDC Fetching comprehensive billing history for user:",e);let t=(0,u.UL)(),r=(0,l.createRouteHandlerClient)({cookies:()=>t}),{data:s,error:i}=await r.from("subscriptions").select("stripe_customer_id").eq("user_id",e).order("created_at",{ascending:!1}).limit(1).single(),o=[];if(!i&&s?.stripe_customer_id)try{let e=(await d.invoices.list({customer:s.stripe_customer_id,limit:100})).data.map(e=>({id:e.id,date:new Date(1e3*e.created).toISOString(),amount:e.amount_paid,status:e.status,type:"subscription",invoice_pdf:e.invoice_pdf,hosted_invoice_url:e.hosted_invoice_url,description:e.lines.data[0]?.description||"Subscription payment"}));o=[...o,...e],console.log(`âœ… Found ${e.length} Stripe invoices`)}catch(e){console.error("âš ï¸ Error fetching Stripe invoices:",e)}try{let{data:t,error:s}=await r.from("stripe_payments").select("*").eq("user_id",e).eq("status","completed").eq("payment_type","single_job").order("created_at",{ascending:!1});if(!s&&t){let e=t.map(async e=>{let t=null;if(e.stripe_session_id)try{let r=await d.checkout.sessions.retrieve(e.stripe_session_id);r.invoice&&(t=(await d.invoices.retrieve(r.invoice)).hosted_invoice_url)}catch(t){console.error(`âš ï¸ Error fetching invoice for session ${e.stripe_session_id}:`,t.message)}return{id:e.stripe_session_id||e.id,date:e.created_at,amount:100*e.amount_paid,status:"paid",type:e.payment_type,description:function(e){switch(e.payment_type){case"single_job":return`Single Job Posting - ${e.job_title||"Job Posting"}`;case"resume_credits_10":return"Resume Credits - 10 Pack";case"resume_credits_25":return"Resume Credits - 25 Pack";case"resume_credits_50":return"Resume Credits - 50 Pack";default:return e.payment_type||"One-time Payment"}}(e),stripe_session_id:e.stripe_session_id,hosted_invoice_url:t}}),r=await Promise.all(e);o=[...o,...r],console.log(`âœ… Found ${r.length} one-time payments`)}}catch(e){console.error("âš ï¸ Error fetching one-time payments:",e)}try{let{data:t,error:s}=await r.from("job_feature_purchases").select("*").eq("user_id",e).order("purchased_at",{ascending:!1});if(!s&&t){let e=t.map(async e=>{let t=null;if(e.stripe_session_id)try{let r=await d.checkout.sessions.retrieve(e.stripe_session_id);r.invoice&&(t=(await d.invoices.retrieve(r.invoice)).hosted_invoice_url)}catch(t){console.error(`âš ï¸ Error fetching invoice for session ${e.stripe_session_id}:`,t.message)}return{id:e.stripe_session_id||e.id,date:e.purchased_at,amount:100*e.amount_paid,status:"paid",type:"feature",description:function(e){switch(e.feature_type){case"featured_listing":case"featured":return"Featured Job Listing";case"urgent_badge":case"urgent":return"Urgent Job Badge";default:return e.feature_type||"Job Feature"}}(e),stripe_session_id:e.stripe_session_id,hosted_invoice_url:t}}),r=await Promise.all(e);o=[...o,...r],console.log(`âœ… Found ${r.length} feature purchases`)}}catch(e){console.error("âš ï¸ Error fetching feature purchases:",e)}return o.sort((e,t)=>new Date(t.date)-new Date(e.date)),console.log(`ðŸ“Š Total billing history items: ${o.length}`),a.NextResponse.json({success:!0,billingHistory:o})}catch(e){return console.error("âŒ Billing history error:",e),a.NextResponse.json({success:!1,error:"Failed to fetch billing history",details:e.message},{status:500})}}function $(e){let t={starter:{planType:"starter",price:19900,jobLimit:3,credits:0},growth:{planType:"growth",price:29900,jobLimit:6,credits:5},professional:{planType:"professional",price:59900,jobLimit:15,credits:25},enterprise:{planType:"enterprise",price:199900,jobLimit:999999,credits:100}};return t[e]||t.starter}let x=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/stripe/manage-subscription/route",pathname:"/api/stripe/manage-subscription",filename:"route",bundlePath:"app/api/stripe/manage-subscription/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/stripe/manage-subscription/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:j,workUnitAsyncStorage:q,serverHooks:N}=x;function R(){return(0,n.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:q})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,2307,3605,2190,7877],()=>r(9270));module.exports=s})();