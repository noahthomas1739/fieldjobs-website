(()=>{var e={};e.id=4411,e.ids=[4411],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},61091:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>g,routeModule:()=>l,serverHooks:()=>m,workAsyncStorage:()=>_,workUnitAsyncStorage:()=>b});var r={};s.r(r),s.d(r,{POST:()=>d});var i=s(96559),o=s(48088),n=s(37719),c=s(32190),a=s(61223),u=s(44999);let p=new(s(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");async function d(e){try{let t=(0,u.UL)(),s=(0,a.createRouteHandlerClient)({cookies:()=>t}),{userId:r}=await e.json();if(!r)return c.NextResponse.json({error:"User ID is required"},{status:400});console.log("\uD83D\uDD0D Starting sync for user:",r);let{data:i}=await s.from("subscriptions").select("stripe_customer_id").eq("user_id",r).limit(1),o=null;if(i&&i.length>0&&(o=i[0].stripe_customer_id),console.log("\uD83D\uDD0D Found existing customer ID:",o),!o){console.log("\uD83D\uDD0D No customer ID in database, searching Stripe customers...");let e=await p.customers.list({limit:100,expand:["data.subscriptions"]});for(let t of(console.log("\uD83D\uDCCA Found",e.data.length,"total customers in Stripe"),e.data))if(t.subscriptions.data.length>0)for(let e of(console.log("\uD83D\uDC64 Customer:",t.id,"has",t.subscriptions.data.length,"subscriptions"),t.subscriptions.data))console.log("  \uD83D\uDCCB Subscription:",e.id,"Status:",e.status,"Price:",e.items.data[0]?.price?.id)}let n=[];if(o)console.log("\uD83D\uDD0D Fetching subscriptions for customer:",o),n=(await p.subscriptions.list({customer:o,status:"active",expand:["data.items.data.price"]})).data,console.log("\uD83D\uDCCA Found",n.length,"active subscriptions for customer");else{console.log("⚠️ No customer ID found, cannot fetch subscriptions");let e=await p.subscriptions.list({status:"active",limit:10,expand:["data.items.data.price","data.customer"]});for(let t of(console.log("\uD83D\uDD0D DEBUG: All active subscriptions in your Stripe account:"),e.data))console.log("  \uD83D\uDCCB Sub:",t.id,"Customer:",t.customer,"Price:",t.items.data[0]?.price?.id);return c.NextResponse.json({success:!1,error:"No customer ID found for user",debug:{totalActiveSubscriptions:e.data.length,subscriptions:e.data.map(e=>({id:e.id,customer:e.customer,status:e.status,priceId:e.items.data[0]?.price?.id}))}})}let d=0,l=[];for(let e of n)try{console.log("\uD83D\uDD04 Processing subscription:",e.id);let t=e.items.data[0].price.id,i={[process.env.NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID]:"starter",[process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID]:"growth",[process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID]:"professional",[process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID]:"enterprise"}[t]||"starter",o=function(e){let t={starter:{active_jobs_limit:3,credits:0},growth:{active_jobs_limit:6,credits:5},professional:{active_jobs_limit:15,credits:25},enterprise:{active_jobs_limit:999999,credits:100}};return t[e]||t.starter}(i);console.log("\uD83D\uDCCB Subscription details:",{id:e.id,priceId:t,planType:i,status:e.status});let{data:n}=await s.from("subscriptions").select("id").eq("stripe_subscription_id",e.id).single();if(n){console.log("✅ Subscription already exists in database:",n.id),l.push({subscriptionId:e.id,action:"already_exists",planType:i});continue}let{data:c,error:a}=await s.from("subscriptions").insert({user_id:r,stripe_customer_id:e.customer,stripe_subscription_id:e.id,plan_type:i,status:"active",active_jobs_limit:o.active_jobs_limit,credits:o.credits,current_period_start:new Date(1e3*e.current_period_start).toISOString(),current_period_end:new Date(1e3*e.current_period_end).toISOString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select().single();a?(console.error("❌ Error creating subscription:",a),l.push({subscriptionId:e.id,action:"error",error:a.message})):(console.log("✅ Created subscription in database:",c.id),d++,l.push({subscriptionId:e.id,action:"created",planType:i,dbId:c.id}))}catch(t){console.error("❌ Error processing subscription:",e.id,t),l.push({subscriptionId:e.id,action:"error",error:t.message})}return console.log("\uD83C\uDFAF Sync completed:",{syncedCount:d,totalProcessed:n.length}),c.NextResponse.json({success:!0,message:`Synced ${d} subscriptions from Stripe`,syncedSubscriptions:d,totalFound:n.length,results:l,debug:{userId:r,stripeCustomerId:o,foundActiveSubscriptions:n.length}})}catch(e){return console.error("❌ Sync error:",e),c.NextResponse.json({success:!1,error:"Failed to sync subscriptions",details:e.message},{status:500})}}let l=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/sync-subscription/route",pathname:"/api/sync-subscription",filename:"route",bundlePath:"app/api/sync-subscription/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/sync-subscription/route.js",nextConfigOutput:"",userland:r}),{workAsyncStorage:_,workUnitAsyncStorage:b,serverHooks:m}=l;function g(){return(0,n.patchFetch)({workAsyncStorage:_,workUnitAsyncStorage:b})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[4243,131,2190,7877],()=>s(61091));module.exports=r})();