(()=>{var e={};e.id=9329,e.ids=[9329],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39727:()=>{},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},47990:()=>{},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},78658:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>_,serverHooks:()=>f,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{POST:()=>l});var i=r(96559),o=r(48088),n=r(37719),c=r(32190),u=r(61223),a=r(44999);let p=new(r(97877)).A(process.env.STRIPE_SECRET_KEY||"sk_test_placeholder");function d(e){try{if(!e)return new Date().toISOString();let t=new Date(1e3*e);if(isNaN(t.getTime()))return new Date().toISOString();return t.toISOString()}catch(e){return console.log("Date conversion error:",e),new Date().toISOString()}}async function l(e){try{let t=(0,a.UL)(),r=(0,u.createRouteHandlerClient)({cookies:()=>t}),{userId:s,customerId:i}=await e.json();if(console.log("\uD83D\uDD27 Quick fix for user:",s,"customer:",i),!s)return c.NextResponse.json({error:"User ID is required"},{status:400});let o=i||"cus_St6N5Rxtuirnsp";console.log("\uD83D\uDD0D Fetching subscriptions for customer:",o);let n=await p.subscriptions.list({customer:o,status:"active",expand:["data.items.data.price"]});if(console.log("\uD83D\uDCCA Found",n.data.length,"active subscriptions"),0===n.data.length)return c.NextResponse.json({success:!0,message:"No active subscriptions found in Stripe",syncedCount:0,totalFound:0,results:[]});let l=0,_=[];for(let e of n.data)try{console.log("\uD83D\uDD04 Processing subscription:",e.id),console.log("\uD83D\uDCCB Subscription details:",{id:e.id,status:e.status,customer:e.customer,created:e.created,current_period_start:e.current_period_start,current_period_end:e.current_period_end});let{data:t}=await r.from("subscriptions").select("id").eq("stripe_subscription_id",e.id).single();if(t){console.log("✅ Already exists:",e.id),_.push({id:e.id,action:"already_exists"});continue}let i=e.items?.data?.[0]?.price?.id;if(!i){console.log("⚠️ No price ID found for subscription:",e.id),_.push({id:e.id,action:"error",error:"No price ID found"});continue}let o={[process.env.NEXT_PUBLIC_STRIPE_STARTER_PRICE_ID]:"starter",[process.env.NEXT_PUBLIC_STRIPE_GROWTH_PLAN_PRICE_ID]:"growth",[process.env.NEXT_PUBLIC_STRIPE_PROFESSIONAL_PRICE_ID]:"professional",[process.env.NEXT_PUBLIC_STRIPE_ENTERPRISE_PRICE_ID]:"enterprise"}[i]||"starter",n=function(e){let t={starter:{active_jobs_limit:3,credits:0},growth:{active_jobs_limit:6,credits:5},professional:{active_jobs_limit:15,credits:25},enterprise:{active_jobs_limit:999999,credits:100}};return t[e]||t.starter}(o);console.log("\uD83D\uDCCB Plan mapping:",{priceId:i,planType:o,limits:n});let c=d(e.current_period_start),u=d(e.current_period_end);console.log("\uD83D\uDCC5 Date conversion:",{raw_start:e.current_period_start,raw_end:e.current_period_end,iso_start:c,iso_end:u});let a={user_id:s,stripe_customer_id:e.customer,stripe_subscription_id:e.id,plan_type:o,status:"active",active_jobs_limit:n.active_jobs_limit,credits:n.credits,current_period_start:c,current_period_end:u,created_at:new Date().toISOString(),updated_at:new Date().toISOString()};console.log("\uD83D\uDCBE Inserting subscription data:",a);let{data:p,error:g}=await r.from("subscriptions").insert(a).select().single();g?(console.error("❌ Database error:",g),_.push({id:e.id,action:"error",error:g.message})):(console.log("✅ Successfully created subscription:",p.id),l++,_.push({id:e.id,action:"created",planType:o,dbId:p.id,nextBilling:u}))}catch(t){console.error("❌ Error processing subscription:",e.id,t),_.push({id:e.id,action:"error",error:t.message})}return console.log("\uD83C\uDFAF Quick fix completed:",{syncedCount:l,totalFound:n.data.length}),c.NextResponse.json({success:!0,message:`Quick fix complete! Synced ${l} subscriptions`,syncedCount:l,totalFound:n.data.length,results:_,debug:{customerId:o,subscriptionsFound:n.data.length}})}catch(e){return console.error("❌ Quick fix error:",e),c.NextResponse.json({success:!1,error:"Quick fix failed",details:e.message,stack:e.stack},{status:500})}}let _=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/quick-fix-subscription/route",pathname:"/api/quick-fix-subscription",filename:"route",bundlePath:"app/api/quick-fix-subscription/route"},resolvedPagePath:"/Users/mattiebrooke/fieldjobs-website/app/api/quick-fix-subscription/route.js",nextConfigOutput:"",userland:s}),{workAsyncStorage:g,workUnitAsyncStorage:x,serverHooks:f}=_;function m(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:x})}},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},79646:e=>{"use strict";e.exports=require("child_process")},81630:e=>{"use strict";e.exports=require("http")},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[4243,131,2190,7877],()=>r(78658));module.exports=s})();